<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Teacher Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link rel="stylesheet" href="/css/teacher-style.css">
  </head>
  <body>
    <nav class="navbar navbar-dark bg-dark">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">Teacher Dashboard</span>
        <div>
          <button
            class="btn btn-outline-light"
            data-bs-toggle="modal"
            data-bs-target="#profileModal"
          >
            <i class="bi bi-person-circle"></i> Profile
          </button>
          <a href="/logout" class="btn btn-outline-danger">Logout</a>
        </div>
      </div>
    </nav>

    <div class="container mt-4">
      <div class="card shadow-sm mb-4">
        <div class="card-body p-4">
          <div class="input-group">
            <input
              type="text"
              id="subjectName"
              class="form-control form-control-lg"
              placeholder="Enter Subject Name"
            />
            <button id="startSessionBtn" class="btn btn-primary btn-lg">
              Start New Session
            </button>
          </div>
          <div class="alert alert-light border mt-3 fs-3" role="alert">
            Session Code:
            <strong id="sessionCodeDisplay" class="text-primary">- - -</strong>
          </div>
        </div>
      </div>

      <div class="card shadow-sm mb-4">
        <div class="card-header fw-bold">Session Controls</div>
        <div class="card-body d-flex gap-2">
          <button id="lockBtn" class="btn btn-danger" disabled>
            Lock Session & Proceed
          </button>
          <button id="reportBtn" class="btn btn-success" disabled>
            Download Attendance Report (CSV)
          </button>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6 mb-4">
          <div class="card shadow-sm">
            <div class="card-header h5">
              Waiting Students (<span
                id="studentCount"
                class="badge bg-secondary rounded-pill"
                >0</span
              >)
            </div>
            <ul id="waitingList" class="list-group list-group-flush"></ul>
          </div>
        </div>
        <div class="col-md-6 mb-4">
          <div class="card shadow-sm">
            <div class="card-header he h5">Final Attendance</div>
            <ul id="attendanceList" class="list-group list-group-flush"></ul>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="profileModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Teacher Profile</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <p>
              <strong>Name:</strong> <span id="profileName">Loading...</span>
            </p>
            <p><strong>Subjects:</strong></p>
            <ul id="profileSubjects" class="list-group"></ul>
          </div>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      id="reconnectModal"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-body text-center">
            <div class="spinner-border text-warning mb-3" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <h4>Connection Lost</h4>
            <p class="text-muted">
              Attempting to reconnect you to the server...
            </p>
          </div>
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // --- INITIAL SETUP & AUTHENTICATION ---
      const token = localStorage.getItem('authToken');
      if (!token) {
        window.location.href = '/login';
      }

      const socket = io({
        auth: { token: token },
        reconnection: true, // Automatically try to reconnect
      });

      // --- PAGE ELEMENTS ---
      const startSessionBtn = document.getElementById('startSessionBtn');
      const sessionCodeDisplay = document.getElementById('sessionCodeDisplay');
      const waitingList = document.getElementById('waitingList');
      const studentCount = document.getElementById('studentCount');
      const attList = document.getElementById('attendanceList');
      const lockBtn = document.getElementById('lockBtn');
      const reportBtn = document.getElementById('reportBtn');
      const profileName = document.getElementById('profileName');
      const profileSubjects = document.getElementById('profileSubjects');
      const reconnectModalElement = document.getElementById('reconnectModal');
      const reconnectModal = new bootstrap.Modal(reconnectModalElement);

      // --- CONNECTION HANDLING ---
      socket.on('connect_error', (err) => {
        // Only log out if the token is invalid, otherwise show reconnect modal
        if (err.message.includes('Invalid token')) {
          alert('Authentication failed. Please log in again.');
          localStorage.clear();
          window.location.href = '/login';
        } else {
          reconnectModal.show();
        }
      });

      socket.on('disconnect', () => reconnectModal.show());
      socket.on('connect', () => reconnectModal.hide());

      // --- PROFILE LOGIC ---
      async function fetchProfileData() {
        try {
          const response = await fetch('/api/user/me');
          const result = await response.json();
          if (result.success) {
            profileName.textContent = result.user.name;
            const subjects = result.user.subjects
              ? result.user.subjects.split(',')
              : [];
            profileSubjects.innerHTML = '';
            if (subjects.length > 0) {
              subjects.forEach((sub) => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = sub.trim();
                profileSubjects.appendChild(li);
              });
            } else {
              profileSubjects.innerHTML =
                '<li class="list-group-item">No subjects listed.</li>';
            }
          }
        } catch (error) {
          console.error('Could not fetch profile data', error);
        }
      }
      fetchProfileData();

      // --- SESSION MANAGEMENT LOGIC ---
      startSessionBtn.addEventListener('click', () => {
        const subject = document.getElementById('subjectName').value;
        if (!subject) {
          alert('Please enter a subject name to start the session.');
          return;
        }
        if (!navigator.geolocation) {
          return alert('Geolocation is not supported by your browser.');
        }

        startSessionBtn.disabled = true;
        startSessionBtn.textContent = 'Getting Location...';

        navigator.geolocation.getCurrentPosition(
          (position) => {
            const teacherLocation = {
              lat: position.coords.latitude,
              lon: position.coords.longitude,
            };
            socket.emit('startSession', {
              subject: subject,
              location: teacherLocation,
            });
            startSessionBtn.textContent = 'Session Started';
            lockBtn.disabled = false;
          },
          (error) => {
            let message =
              'Could not get your location. Please check OS/Browser settings.';
            switch (error.code) {
              case error.PERMISSION_DENIED:
                message =
                  'You denied the request for Geolocation. Please allow location access.';
                break;
              case error.POSITION_UNAVAILABLE:
                message =
                  'Location information is unavailable. This can be due to a poor signal or network issue.';
                break;
              case error.TIMEOUT:
                message = 'The request to get your location timed out.';
                break;
            }
            alert(`Error: ${message}`);
            startSessionBtn.disabled = false;
            startSessionBtn.textContent = 'Start New Session';
          },
        );
      });

      lockBtn.addEventListener('click', () => {
        socket.emit('lockSession');
        lockBtn.disabled = true;
        lockBtn.textContent = 'Session Locked';
      });

      reportBtn.addEventListener('click', () => {
        socket.emit('getReport');
      });

      // --- SOCKET EVENT LISTENERS ---
      socket.on('sessionCode', (code) => {
        sessionCodeDisplay.textContent = code;
        waitingList.innerHTML = '';
        attList.innerHTML = '';
        studentCount.textContent = 0;
        reportBtn.disabled = true;
      });

      socket.on('waitingList', (students) => {
        waitingList.innerHTML = '';
        studentCount.textContent = students.length;
        students.forEach((s) => {
          const li = document.createElement('li');
          li.className =
            'list-group-item d-flex justify-content-between align-items-center';
          li.textContent = `${s.name} (${s.enrollment})`;

          const removeBtn = document.createElement('button');
          removeBtn.className = 'btn btn-danger btn-sm';
          removeBtn.textContent = 'Remove';
          removeBtn.onclick = () => {
            if (confirm(`Are you sure you want to remove ${s.name}?`)) {
              socket.emit('removeStudent', s.enrollment);
            }
          };

          li.appendChild(removeBtn);
          waitingList.appendChild(li);
        });
      });

      socket.on('attendanceUpdate', (list) => {
        attList.innerHTML = '';
        reportBtn.disabled = list.length === 0;
        list.forEach((s) => {
          const li = document.createElement('li');
          li.className = 'list-group-item';
          li.textContent = `${s.name} (${s.enrollment}) at ${s.timestamp}`;
          attList.appendChild(li);
        });
      });

      socket.on('reportData', (csvData) => {
        const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        const date = new Date().toISOString().slice(0, 10);
        link.setAttribute('download', `attendance-report-${date}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });
    </script>
  </body>
</html>
